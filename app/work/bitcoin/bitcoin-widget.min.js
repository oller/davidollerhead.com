var BitcoinWidget = function () {

    var self = this;

    // Detect protocol for approriate resource loading
    self._protocol = window.location.protocol;

    self.initialize = function () {

        if (!window.jQuery) return;

        self._widget = document.getElementById('bitcoin-widget');
        if (self._widget === null) {
            alert('Please ensure you have included the tag where you want the widget to appear.  Using the markup: <div id="bitcoin-widget"></div>');
        }

        self._widget.layout = self._widget.getAttribute('data-size');
        if (!self._widget.layout) {
            console.warn('No layout specified by attribute \'data-size\', defaulting to \'small\'. Supports \'mpu\'(300x250) and \'small\'(210x130). For example: <div id="bitcoin-widget" data-size="mpu"></div>');
        }

        self._widget.alignment = self._widget.getAttribute('data-align');
        if (!self._widget.alignment) {
            console.warn('No alignment specified by attribute \'data-align\', defaulting to \'left\'. Supports \'left\', \'center\' and \'right\'.');
        }

        self._modernBrowsers = (!(jQuery.browser.msie && jQuery.browser.versionNumber <= 8));

        // Lookup dimensions from friendly layout name
        self.getDimensions(self._widget.layout);
        // Get alignment settings and configure accordingly
        self.getAlignment(self._widget.alignment);
        // Create template accoriding to defined dimensions
        self.createTemplate();
        // Write the widget to the DOM
        self.createWidget();
        // Get historical data to initially populate sparkline
        self.getHistoryData();
        // Get current data to display and update sparkline
        self.getCurrentData();
    };

    self.createTemplate = function () {

        var logoBitcoinPngSmall = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAMAAAAM7l6QAAAAVFBMVEUAAAD+vhL+vhL+vhL+vhL+vhL+vhL+vhL+vhL+vhL+vhL////+vhL+zk3/78T/9+H+xjD+yj7/89P/56b/+/D+1mv+wiH/45f/34n+2nr/67X+0lyhkP7iAAAAC3RSTlMAEL/PcCCPMK/vQNeqw9EAAAD6SURBVHhefZNJlsMgDAUJwaPE7DF9/3s2xEYoLFwbFsXTFyAE0Sk5YWKSqhMtw4iMcfi1PTb0rypfbxLE+8Xtg2f2E91WfZu7AeBiKT/boThrjhOMB9KY+y8ncpCxASJpKUSHBR/hIrriO6GQ+EvqCMkv/tZKyKp3AIOok/9Q9anqAHCkxeRdN+LnVBC1XvNCmkcXFl81j7bfzmBF0m20zhtcq7cz19Z3xklaXvqETM48WHVZrmVfrqaMBVZc1Uv1AQp7vVQx1tZ0gGCMOdmTiIG/NThkzGwctnX1YLnt21Fzvhm251F8HmTyT98gM0su5UyCfcHL8S/4D3L7I3j7U/aqAAAAAElFTkSuQmCC";
        var logoBitcoinPngMPU = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAoCAMAAAC7IEhfAAAAXVBMVEUAAAD+vhL+vhL+vhL+vhL+vhL+vhL+vhL+vhL+vhL+vhL+vhL+vhL+vhL////+vhL/34n+0lz/78T/9+H+zk3/89P+wiH+yj7/67X/56b+1mv/+/D+xjD+2nr/45cPEa9LAAAADnRSTlMAzxBAv2CPr5/vIDDfUP1vqD4AAAFgSURBVHhehZRZksMgDAXBMfGS5InNe5L7H3Nq7EwQ2Iz7u0slCfFERKFqSSuyVoXIcakoorocayXtKA/UKx1yTRooJGWQkXm7U5bmxurF3jMxQ00Ze3BzJMvieI4ZMAPczCb67CU4XnuiCehfgKfAtiW2vzcA69DRCBCjTAqSxYZbYImSkvzdetPhj4nPUwlRUIQHgAUrmpmtULGoATga3qv7CqISdSxaABMRDb+mC2KdLJsAYP4sgE8uxUGL6xQOwEIBsW8Ri9XarYPnRQtG1+fFtc64MI+L+xa3vdu8qL87GdfxuSj56bjvBD55GskW3gGhjE7EOjyhx8YyamMmANFJqnAUz3lyiHAUaOMzG8DgBcvkcA1gDDYs8+ix/wr9DHhKkOnn6tDRBFDKZRc73pCDTb3rcfB4n42foqF/aFoWUs1pSJ3HXpsE5GmQnkfzediXD5GjVdWn2Xul4uZ+AHp5TDd9jCYnAAAAAElFTkSuQmCC";
        var logoBitcoinVector = "data:image/svg+xml;base64,PHN2ZyB4bWxucz0naHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmcnIHZpZXdCb3g9JzAgMCA1MTIgNTEyJyBwcmVzZXJ2ZUFzcGVjdFJhdGlvPSd4TWlkWU1pZCBtZWV0JyB3aWR0aD0nMTAwJScgaGVpZ2h0PScxMDAlJz48ZyBpZD0nZzE2JyB0cmFuc2Zvcm09J3NjYWxlKDAuMDE1NjI1KSc+PHBhdGggaWQ9J2NvaW4nIGZpbGw9JyNGRUJFMTInIGQ9J00zMjI3NC4zOTEsMjAzNDcuMzc1Yy0yMTg4LjMxMiw4Nzc3LjI1LTExMDc4LjE4OCwxNDExOC45MzgtMTk4NTYuMzc1LDExOTMwLjEyNQlDMzY0My4zMjgsMzAwODkuMTg4LTE2OTguMzU5LDIxMTk4Ljg3NSw0OTAuOTUzLDEyNDIyLjE1NkMyNjc4LjIwMywzNjQzLjkwNiwxMTU2OC4wNzgtMTY5OC4zMTIsMjAzNDMuNzY2LDQ5MAlDMjkxMjEuNDUzLDI2NzguMjgxLDM0NDYyLjY0MSwxMTU2OS42NTYsMzIyNzQuMzkxLDIwMzQ3LjM3NUwzMjI3NC4zOTEsMjAzNDcuMzc1eicvPjxwYXRoIGlkPSdzeW1ib2wnIGZpbGw9JyNGRkZGRkYnIGQ9J00yMzYwMy42NDEsMTQwNDkuNzgxYzMyNi4xMjUtMjE4MC4wOTQtMTMzMy43NS0zMzUyLjA2Mi0zNjAzLjQzOC00MTMzLjg3NWw3MzYuMjUtMjk1My4yMTkJbC0xNzk3LjYyNS00NDhsLTcxNi44MTIsMjg3NS4zNzVjLTQ3Mi41NjItMTE3Ljc1LTk1Ny45MzgtMjI4Ljg0NC0xNDQwLjI1LTMzOC45MzhsNzIxLjkzOC0yODk0LjMxMmwtMTc5Ni42MjUtNDQ4TDE0OTcwLjMyOCw4NjYxCWMtMzkxLjE4OC04OS4wOTQtNzc1LjE4OC0xNzcuMTU2LTExNDcuOTM4LTI2OS44NDRsMi4wNjItOS4yMTlsLTI0NzkuMTI1LTYxOWwtNDc4LjE4OCwxOTIwYzAsMCwxMzMzLjc1LDMwNS42ODgsMTMwNS42MjUsMzI0LjYyNQljNzI4LjA2MiwxODEuNzUsODU5LjYyNSw2NjMuNTMxLDgzNy42MjUsMTA0NS41bC04MzguNjg4LDMzNjQuMzQ0YzUwLjE4OCwxMi44MTIsMTE1LjE4OCwzMS4yMTksMTg2Ljg3NSw1OS45MDYJYy01OS44NzUtMTQuODQ0LTEyMy44NzUtMzEuMjUtMTg5LjkzOC00Ny4wOTRsLTExNzUuNTYyLDQ3MTIuOTA2Yy04OS4wNjIsMjIxLjI1LTMxNC44NzUsNTUzLTgyMy44MTIsNDI3LjA2MgljMTcuOTM4LDI2LjA2Mi0xMzA2LjYyNS0zMjYuMTg4LTEzMDYuNjI1LTMyNi4xODhsLTg5Mi4zNzUsMjA1Ny43NWwyMzM5LjMxMiw1ODMuMTg4CWM0MzUuMTg4LDEwOS4wNjIsODYxLjY4OCwyMjMuMTg4LDEyODEuNTYyLDMzMC43NWwtNzQzLjkzOCwyOTg3bDE3OTUuNTYyLDQ0OGw3MzYuNzUtMjk1NS4yNQljNDkwLjUsMTMzLjA2Miw5NjYuNjg4LDI1NiwxNDMyLjU2MiwzNzEuNjg4bC03MzQuMTg4LDI5NDEuNDM4bDE3OTcuNjI1LDQ0OGw3NDMuOTM4LTI5ODEuMzc1CWMzMDY1LjMxMiw1ODAuMDYyLDUzNzAuMzc1LDM0Ni4xMjUsNjM0MC42MjUtMjQyNi4zMTJjNzgxLjgxMi0yMjMyLjM3NS0zOC45MzgtMzUyMC0xNjUxLjc1LTQzNTkuNzUJQzIyNDgyLjg5MSwxNjQxOC4zMTIsMjMzNjcuNTc4LDE1NjQ1LjY4OCwyMzYwMy42NDEsMTQwNDkuNzgxTDIzNjAzLjY0MSwxNDA0OS43ODF6IE0xOTQ5Ni4zOTEsMTk4MDkuMjUJYy01NTUuNSwyMjMyLjM3NS00MzE0LjEyNSwxMDI1LjU2Mi01NTMyLjY4OCw3MjNsOTg3LjE4OC0zOTU3LjI1QzE2MTY5LjM5MSwxNjg3OS4xMjUsMjAwNzcuMDE2LDE3NDgxLjI1LDE5NDk2LjM5MSwxOTgwOS4yNXpNMjAwNTIuMzkxLDE0MDE3LjUzMWMtNTA2Ljg3NSwyMDMwLjU5NC0zNjM1LjE4OCw5OTguOTA2LTQ2NDkuOTM4LDc0Nmw4OTQuOTM4LTM1ODkuMTI1CUMxNzMxMi4yMDMsMTE0MjcuMzEyLDIwNTgwLjI2NiwxMTg5OS4zNzUsMjAwNTIuMzkxLDE0MDE3LjUzMXonLz48L2c+PC9zdmc+DQo=";
        var logoCoindeskPngSmall = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAMAAAAM7l6QAAAAkFBMVEX9wgwAAAD+y0b+ykD9wgxGNwmDZgplTgr9wgz+y0ZEPSoJCQhzYTE5MyShhDixiAvutgyScQpVQwmifQvbsEGKcjXEnz2VezbywkTXqzS4ljzPnwvQqD9+aTN0WgoNDArAlA9bTy60kTLnuUMrIwtZRgutjTpKOwtnWC/9wxD+yTtQRizutw/AlAsYFQj+ykK0d/qAAAAABXRSTlOPAI+PELoY6a8AAAEeSURBVHhefdFHbsMwAERR2gl7Ue/Fvabd/3YZIYBDyTC1+JsHkgOIrN5+5KtvvSLrV4bcCQnpTZCgggP64N6dp7RStq6c0kMf3CulihJxDmkrpexW/LODqAExZsqHshvm8Rmyq5BhQIqr3ejEY1moXV4bZfIDUjdHzWOfy6GqZ5tB82lG5i6XSHMTEYvFchpqpDT2JATVzOf277RppdxfIiEy2vksnRny+btLPiz1+fL9TXzRzr/cn2Yv0yr+NK2EGtmcsKrjOBil82mtKerFKp+rj2vzyTWN41SncUf1uJhmj0xrnXKEUySZTcM/SiGUTvlGmMc9lEeQkSHZiEQe37csiUXEcGPGMiESBn2wt3kRElJwSMHroJIVCej7L2jCKiBh+vRwAAAAAElFTkSuQmCC";
        var logoCoindeskPngMPU = "data:image/png;base64,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";
        var logoCoindeskVector = "data:image/svg+xml;base64,PHN2ZyB4bWxucz0naHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmcnIHZpZXdCb3g9JzAgMCAxMjYuMjQgMTI2LjIzMicgcHJlc2VydmVBc3BlY3RSYXRpbz0neE1pZFlNaWQgbWVldCcgd2lkdGg9JzEwMCUnIGhlaWdodD0nMTAwJSc+PGc+PGc+PHBhdGggZmlsbD0nI0ZEQzIwQycgZD0nTTAsMTQuOTg2QzAsNi43NDQsNi43NDQsMCwxNC45ODYsMGg5Ni4yNjhjOC4yNDIsMCwxNC45ODYsNi43NDQsMTQuOTg2LDE0Ljk4NnY5Ni4yNmMwLDguMjQyLTYuNzQ0LDE0Ljk4Ni0xNC45ODYsMTQuOTg2SDE0Ljk4NkM2Ljc0NCwxMjYuMjMyLDAsMTE5LjQ4OCwwLDExMS4yNDZWMTQuOTg2eicvPjwvZz48cGF0aCBmaWxsPScjRkVDQjQ2JyBkPSdNMTExLjI5MywwLjAwMkgxNC45NDZDNi43MjIsMC4wMjUsMCw2Ljc1OCwwLDE0Ljk4NnY5Ni4yNmMwLDQuMDg4LDEuNjYxLDcuODAzLDQuMzM4LDEwLjUxNEwxMjEuNzY0LDQuMzM2QzExOS4wNjIsMS42NywxMTUuMzYzLDAuMDE0LDExMS4yOTMsMC4wMDJ6Jy8+PGc+PHBhdGggZmlsbD0nIzA5MDkwOCcgZD0nTTczLjM1MSw2OC44ODljLTIuNDYsMC00LjQ1NiwxLjk5OC00LjQ1Niw0LjQ2MWMwLDIuNDY3LDEuOTk2LDQuNDY3LDQuNDU2LDQuNDY3YzIuNDY2LDAsNC40Ny0yLDQuNDctNC40NjdDNzcuODIsNzAuODg3LDc1LjgxNiw2OC44ODksNzMuMzUxLDY4Ljg4OXonLz48cGF0aCBmaWxsPScjMDkwOTA4JyBkPSdNMzguNjU0LDg3LjQ0NWwtMTIuNjIxLDEyLjYyMWMxLjYyLDEuNjU2LDMuODc3LDIuNjg2LDYuMzc4LDIuNjg2YzQuOTMsMCw4LjkzLTMuOTk2LDguOTMtOC45MjhDNDEuMzQyLDkxLjMyLDQwLjMxMSw4OS4wNjIsMzguNjU0LDg3LjQ0NXonLz48cGF0aCBmaWxsPScjMDkwOTA4JyBkPSdNNTIuODgxLDc3LjgxNmMyLjQ2NiwwLDQuNDY0LTIsNC40NjQtNC40NjdjMC0xLjI2Ni0wLjUzNC0yLjQwNC0xLjM4MS0zLjIxNWwtNi4zLDYuMjk5QzUwLjQ3OCw3Ny4yODEsNTEuNjE1LDc3LjgxNiw1Mi44ODEsNzcuODE2eicvPjxwYXRoIGZpbGw9JyMwOTA5MDgnIGQ9J001Mi44ODUsODQuODk2Yy00LjkzNCwwLTguOTMzLDMuOTktOC45MzMsOC45MjhjMCw0LjkzMiwzLjk5OSw4LjkyOCw4LjkzMyw4LjkyOGM0LjkyOCwwLDguOTI1LTMuOTk2LDguOTI1LTguOTI4QzYxLjgxMSw4OC44ODcsNTcuODEzLDg0Ljg5Niw1Mi44ODUsODQuODk2eicvPjxwYXRoIGZpbGw9JyMwOTA5MDgnIGQ9J003My4zNTEsNTcuMzQ4YzIuNDY2LDAsNC40Ny0yLDQuNDctNC40NjNjMC0xLjI2OC0wLjUzNS0yLjQwNi0xLjM4Ni0zLjIyMWwtNi4yOTksNi4yOTdDNzAuOTQ3LDU2LjgxMiw3Mi4wODQsNTcuMzQ4LDczLjM1MSw1Ny4zNDh6Jy8+PHBhdGggZmlsbD0nIzA5MDkwOCcgZD0nTTkzLjgyNiw1Ny4zNDhjMi40NjYsMCw0LjQ2MS0yLDQuNDYxLTQuNDYzYzAtMi40NjUtMS45OTUtNC40NjktNC40NjEtNC40NjljLTIuNDY3LDAtNC40NjUsMi4wMDQtNC40NjUsNC40NjlDODkuMzYxLDU1LjM0OCw5MS4zNTksNTcuMzQ4LDkzLjgyNiw1Ny4zNDh6Jy8+PHBhdGggZmlsbD0nIzA5MDkwOCcgZD0nTTczLjM1MSw4NC44OTZjLTQuOTI3LDAtOC45MjQsMy45OS04LjkyNCw4LjkyOGMwLDQuOTMyLDMuOTk3LDguOTI4LDguOTI0LDguOTI4YzQuOTM2LDAsOC45My0zLjk5Niw4LjkzLTguOTI4QzgyLjI4LDg4Ljg4Nyw3OC4yODYsODQuODk2LDczLjM1MSw4NC44OTZ6Jy8+PHBhdGggZmlsbD0nIzA5MDkwOCcgZD0nTTEwMC4wNjcsMjYuMDMxTDg3LjQ0NSwzOC42NTJjMS42MjEsMS42NTgsMy44NzksMi42ODgsNi4zODEsMi42ODhjNC45MjgsMCw4LjkzLTMuOTk0LDguOTMtOC45MjZDMTAyLjc1NiwyOS45MTIsMTAxLjcyNSwyNy42NTIsMTAwLjA2NywyNi4wMzF6Jy8+PHBhdGggZmlsbD0nIzA5MDkwOCcgZD0nTTkzLjgyNiw3Ny44MTZjMi40NjYsMCw0LjQ2MS0yLDQuNDYxLTQuNDY3YzAtMi40NjMtMS45OTUtNC40NjEtNC40NjEtNC40NjFjLTIuNDY3LDAtNC40NjUsMS45OTgtNC40NjUsNC40NjFDODkuMzYxLDc1LjgxNiw5MS4zNTksNzcuODE2LDkzLjgyNiw3Ny44MTZ6Jy8+PHBhdGggZmlsbD0nIzA5MDkwOCcgZD0nTTkzLjgyNiw4NC44OTZjLTQuOTMyLDAtOC45MjcsMy45OS04LjkyNyw4LjkyOGMwLDQuOTMyLDMuOTk1LDguOTI4LDguOTI3LDguOTI4YzQuOTI4LDAsOC45My0zLjk5Niw4LjkzLTguOTI4QzEwMi43NTYsODguODg3LDk4Ljc1NCw4NC44OTYsOTMuODI2LDg0Ljg5NnonLz48L2c+PGc+PHBhdGggZmlsbD0nIzQ0M0QyQScgZD0nTTQ4LjQxOSw1Mi44ODVjMCwyLjQ2MywxLjk5OCw0LjQ2Myw0LjQ2Miw0LjQ2M2MyLjQ2NiwwLDQuNDY0LTIsNC40NjQtNC40NjNjMC0yLjQ2NS0xLjk5OC00LjQ2OS00LjQ2NC00LjQ2OUM1MC40MTcsNDguNDE2LDQ4LjQxOSw1MC40Miw0OC40MTksNTIuODg1eicvPjxwYXRoIGZpbGw9JyM0NDNEMkEnIGQ9J002NC40MjcsMzIuNDE0YzAsNC45MzIsMy45OTcsOC45MjYsOC45MjQsOC45MjZjNC45MzYsMCw4LjkzLTMuOTk0LDguOTMtOC45MjZjMC00LjkzNC0zLjk5NC04LjkzNC04LjkzLTguOTM0QzY4LjQyNCwyMy40OCw2NC40MjcsMjcuNDgsNjQuNDI3LDMyLjQxNHonLz48cGF0aCBmaWxsPScjNDQzRDJBJyBkPSdNNjEuODExLDMyLjQxNGMwLTQuOTM0LTMuOTk4LTguOTM0LTguOTI1LTguOTM0Yy00LjkzNCwwLTguOTMzLDQtOC45MzMsOC45MzRjMCw0LjkzMiwzLjk5OSw4LjkyNiw4LjkzMyw4LjkyNkM1Ny44MTMsNDEuMzQsNjEuODExLDM3LjM0Niw2MS44MTEsMzIuNDE0eicvPjxwYXRoIGZpbGw9JyM0NDNEMkEnIGQ9J00zMi40MTIsODQuODk2Yy00LjkzNCwwLTguOTI3LDMuOTktOC45MjcsOC45MjhjMCwyLjQzLDAuOTczLDQuNjMzLDIuNTQ5LDYuMjQybDEyLjYyMS0xMi42MjFDMzcuMDQ0LDg1Ljg2OSwzNC44NDMsODQuODk2LDMyLjQxMiw4NC44OTZ6Jy8+PHBhdGggZmlsbD0nIzQ0M0QyQScgZD0nTTg0Ljg5OSwzMi40MTRjMCwyLjQzLDAuOTc0LDQuNjI5LDIuNTQ2LDYuMjM4bDEyLjYyMi0xMi42MjFjLTEuNjEyLTEuNTc2LTMuODEzLTIuNTUxLTYuMjQxLTIuNTUxQzg4Ljg5NSwyMy40OCw4NC44OTksMjcuNDgsODQuODk5LDMyLjQxNHonLz48cGF0aCBmaWxsPScjNDQzRDJBJyBkPSdNNDguNDE5LDczLjM1YzAsMS4xOTksMC40NzksMi4yODEsMS4yNDYsMy4wODRsNi4zLTYuMjk5Yy0wLjgwMi0wLjc2OC0xLjg4NS0xLjI0Ni0zLjA4My0xLjI0NkM1MC40MTcsNjguODg5LDQ4LjQxOSw3MC44ODcsNDguNDE5LDczLjM1eicvPjxwYXRoIGZpbGw9JyM0NDNEMkEnIGQ9J00zMi40MTIsNDMuOTUzYy00LjkzNCwwLTguOTI3LDQtOC45MjcsOC45MzJzMy45OTMsOC45MjIsOC45MjcsOC45MjJjNC45MywwLDguOTMtMy45OSw4LjkzLTguOTIyUzM3LjM0Miw0My45NTMsMzIuNDEyLDQzLjk1M3onLz48cGF0aCBmaWxsPScjNDQzRDJBJyBkPSdNNjguODk1LDUyLjg4NWMwLDEuMTk1LDAuNDc3LDIuMjc3LDEuMjQxLDMuMDc2bDYuMjk5LTYuMjk3Yy0wLjgwNC0wLjc2OC0xLjg4Ni0xLjI0OC0zLjA4NC0xLjI0OEM3MC44OTEsNDguNDE2LDY4Ljg5NSw1MC40Miw2OC44OTUsNTIuODg1eicvPjxwYXRoIGZpbGw9JyM0NDNEMkEnIGQ9J00zMi40MTIsMjMuNDhjLTQuOTM0LDAtOC45MjcsNC04LjkyNyw4LjkzNGMwLDQuOTMyLDMuOTkzLDguOTI2LDguOTI3LDguOTI2YzQuOTMsMCw4LjkzLTMuOTk0LDguOTMtOC45MjZDNDEuMzQyLDI3LjQ4LDM3LjM0MiwyMy40OCwzMi40MTIsMjMuNDh6Jy8+PHBhdGggZmlsbD0nIzQ0M0QyQScgZD0nTTMyLjQxMiw2NC40MmMtNC45MzQsMC04LjkyNyw0LjAwMi04LjkyNyw4LjkzYzAsNC45MzQsMy45OTMsOC45MzQsOC45MjcsOC45MzRjNC45MywwLDguOTMtNCw4LjkzLTguOTM0QzQxLjM0Miw2OC40MjIsMzcuMzQyLDY0LjQyLDMyLjQxMiw2NC40MnonLz48L2c+PC9nPjwvc3ZnPgo=";
        var logoBitcoin, logoCoinDesk;

        // Set logos to PNG for  < IE8 (No .svg support)
        if (self._modernBrowsers) {
            logoCoinDesk = logoCoindeskVector;
            logoBitcoin = logoBitcoinVector;
        } else {
            switch (self._widget.config.name){
                case 'mpu':
                    logoCoinDesk = logoCoindeskPngMPU;
                    logoBitcoin = logoBitcoinPngMPU;
                    break;
                case 'small':
                /* falls through */
                default:
                    logoCoinDesk = logoCoindeskPngSmall;
                    logoBitcoin = logoBitcoinPngSmall;
                    break;
            }
        }

        self._currencies = ['USD' /*, 'EUR', 'GBP'*/];
        self._metrics = ['high', 'low'];
        self._elements = {};
        self._data = {};
        self._range = {};
        self._history = [];
        self._apiHistoryUrl = self._protocol +'//api.coindesk.com/tickerdata/history';
        self._apiCurrentUrl = self._protocol +'//api.coindesk.com/v1/bpi/currentprice.json';
        self._urlCoinDeskPrice = 'http://www.coindesk.com/price/';
        self._pollingDelay = 60000; // Frequency between updating data in ms (1000ms = 1s)

        // Styles have to go last for IE Bug - http://jonathonhill.net/2011-10-12/ie-innerhtml-style-bug/
        self._template = [
            '<div class="btc-box" style="font-family: Helvetica, \'Helvetia Neue\', Arial; position: relative; cursor: default; overflow:hidden; background-color: #353536; width: ' + self._widget.config.width + 'px; height: ' + self._widget.config.height + 'px; line-height: 1; border-radius: 4px; ' + self._widget.config.alignment + ' ">',
                '<div class="widget-loading" id="btc-slider">',
                    '<div class="btc-box">',
                        '<div id="sparkline" style="width:' + (self._widget.config.width+10) + 'px; height:' + self._widget.config.spark.height + 'px; position: absolute; right: -10px; top: ' + (self._widget.config.padding - 5)+ 'px; overflow: hidden;"></div>',
                        '<div id="coindesk-logo" style="position: absolute; z-index: 2;  width: ' + self._widget.config.logo.coindesk.size + 'px; height: ' + self._widget.config.logo.coindesk.size + 'px; background-size: contain; background-repeat: no-repeat; bottom: ' + self._widget.config.padding + 'px; right: ' + self._widget.config.padding + 'px;"><a style="display:block; width: 100%; height: 100%" href="' + self._urlCoinDeskPrice + '" title="See the latest bitcoin news and prices at CoinDesk" target="_blank"></a></div>',
                        '<div style="position: absolute; left: ' + self._widget.config.padding + 'px; bottom: ' + self._widget.config.padding + 'px;">',
                            '<span class="btc-latest" title="Latest bitcoin price in USD taken from CoinDesk\'s bitcoin index" style="float: left; position: relative; z-index: 2; font-weight: bold; font-size: ' + self._widget.config.text.primary + 'px; height: ' + self._widget.config.text.primary + 'px">',
                                '<div id="btc-logo" style="float: left; margin:0 8px -4px 0; width: ' + self._widget.config.logo.bitcoin.size + 'px; height: ' + self._widget.config.logo.bitcoin.size + 'px; background-size: contain; background-repeat: no-repeat;"></div>',
                                '<span class="animated" id="btc-usd-field"></span>',
                            '</span>',
                            '<div style="line-height: '+ (2 * self._widget.config.text.normal ) +'px; clear: left;">',
                                // '<span style="color: #999; font-size: ' + self._widget.config.text.normal + 'px; display: inline-block;">EUR: <b><span id="btc-eur-field"></span></b></span>',
                                // '<span style="color: #999; font-size: ' + self._widget.config.text.normal + 'px; display: inline-block; margin-left: 6px;">GBP: <b><span id="btc-gbp-field"></span></b></span>',
                                '<span style="color: #CCC; font-size: ' + self._widget.config.text.normal + 'px; display: inline-block;">High: <b><span id="btc-range-high"></span></b></span>',
                                '<span style="color: #CCC; font-size: ' + self._widget.config.text.normal + 'px; display: inline-block; margin-left: 6px;">Low: <b><span id="btc-range-low"></span></b></span>',
                            '</div>',
                            '<div style="font-size: ' + self._widget.config.text.small + 'px; color: #999; ">',
                                'Powered by <a href="' + self._urlCoinDeskPrice + '" title="See the latest bitcoin news and prices at CoinDesk" target="_blank" style="color: #fbc205; text-decoration: underline; cursor: pointer">CoinDesk</a>',
                            '</div>',
                        '</div>',
                    '</div>',
                    '<div class="btc-box" style="text-align: center; line-height: ' + self._widget.config.height + 'px; color: #999;">',
                        '<div class="loading">Loading</div>',
                    '</div>',
                '</div>',
            '</div>',
            '<style type="text/css">',
                '.btc-latest {transition: 0.2s linear color; -o-transition: 0.2s linear color; -moz-transition: 0.2s linear color; -webkit-transition: 0.2s linear color; color: #EEE;} .delta-down {color: #C3342B;} .delta-up {color: #5D8700;} .btc-path {-webkit-transition: 0.2s linear opacty; stroke: #dfdfdf; stroke-width: 1.5px; fill: none; }',
                '.btc-box {height: ' + self._widget.config.height + 'px; width: ' + self._widget.config.width + 'px; position: relative}',
                '#btc-slider {transition: 0.1s ease-in top; -o-transition: 0.1s ease-in top; -moz-transition: 0.1s ease-in top; -webkit-transition: 0.1s ease-in top; top: 0px; position: relative;}',
                '#btc-slider.widget-loading {top: -' + self._widget.config.height + 'px;}',
                '.btc-box:hover .btc-path {stroke: #fbc205}',
                '#btc-logo {background-image: url("' + logoBitcoin + '");}',
                '#coindesk-logo {background-image: url("' + logoCoinDesk + '");}',
                '.btc-box .overlay {fill: none; pointer-events: all;}',
                '.btc-box .focus .tooltipBg { fill: #333; fill-opacity: 0.8;}',
                '.btc-box .focus circle { fill: none; stroke: #FBC001; stroke-width: 2;}',
                '.btc-box .focus text {fill: #EEE; font-weight: normal; font-size: 12px;}',
                '.btc-box .focus line { stroke: #FBC001; stroke-dasharray: 3 3; opacity: .8;}',
                '.animated { -webkit-animation-duration: 1s; -moz-animation-duration: 1s; -o-animation-duration: 1s; animation-duration: 1s;}',
                '@-webkit-keyframes fadeInUp {0% {opacity: 0;-webkit-transform: translateY(20px);}100% {opacity: 1;-webkit-transform: translateY(0);}}',
                '@-moz-keyframes fadeInUp {0% {opacity: 0;-moz-transform: translateY(20px);}100% {opacity: 1;-moz-transform: translateY(0);}}',
                '@-o-keyframes fadeInUp {0% {opacity: 0;-o-transform: translateY(20px);}100% {opacity: 1;-o-transform: translateY(0);}}',
                '@keyframes fadeInUp {0% {opacity: 0;transform: translateY(20px);}100% {opacity: 1;transform: translateY(0);}}',
                '.animated.fadeInUp {-webkit-animation-name: fadeInUp;-moz-animation-name: fadeInUp;-o-animation-name: fadeInUp;animation-name: fadeInUp;}',
                '@-webkit-keyframes fadeInDown {0% {opacity: 0;-webkit-transform: translateY(-20px);}100% {opacity: 1;-webkit-transform: translateY(0);}}',
                '@-moz-keyframes fadeInDown {0% {opacity: 0;-moz-transform: translateY(-20px);}100% {opacity: 1;-moz-transform: translateY(0);}}',
                '@-o-keyframes fadeInDown {0% {opacity: 0;-o-transform: translateY(-20px);}100% {opacity: 1;-o-transform: translateY(0);}}',
                '@keyframes fadeInDown {0% {opacity: 0;transform: translateY(-20px);}100% {opacity: 1;transform: translateY(0);}}',
                '.animated.fadeInDown {-webkit-animation-name: fadeInDown;-moz-animation-name: fadeInDown;-o-animation-name: fadeInDown;animation-name: fadeInDown;}',
                '.loading { text-indent: 999em; overflow: hidden; border-bottom:6px solid rgba(0, 0, 0, .4);border-left:6px solid rgba(0, 0, 0, .4);border-right:6px solid rgba(0, 0, 0, .4);border-top:6px solid rgba(254, 190, 18, .8);border-radius:100%;height:30px;width:30px;margin: 0 auto; margin-top: '+ ((self._widget.config.height - 42 /*30px loader + 12px border*/ ) / 2) +'px;-webkit-animation:rot .6s infinite linear;-moz-animation:rot .6s infinite linear;-ms-animation:rot .6s infinite linear;-o-animation:rot .6s infinite linear;animation:rot .6s infinite linear;}@keyframes "rot"{from{-webkit-transform:rotate(0deg);-moz-transform:rotate(0deg);-o-transform:rotate(0deg);-ms-transform:rotate(0deg);transform:rotate(0deg);}to{-webkit-transform:rotate(359deg);-moz-transform:rotate(359deg);-o-transform:rotate(359deg);-ms-transform:rotate(359deg);transform:rotate(359deg);}}@-moz-keyframes rot{from{-webkit-transform:rotate(0deg);-moz-transform:rotate(0deg);-o-transform:rotate(0deg);-ms-transform:rotate(0deg);transform:rotate(0deg);}to{-webkit-transform:rotate(359deg);-moz-transform:rotate(359deg);-o-transform:rotate(359deg);-ms-transform:rotate(359deg);transform:rotate(359deg);}}@-webkit-keyframes "rot"{from{-webkit-transform:rotate(0deg);-moz-transform:rotate(0deg);-o-transform:rotate(0deg);-ms-transform:rotate(0deg);transform:rotate(0deg);}to{-webkit-transform:rotate(359deg);-moz-transform:rotate(359deg);-o-transform:rotate(359deg);-ms-transform:rotate(359deg);transform:rotate(359deg);}}@-ms-keyframes "rot"{from{-webkit-transform:rotate(0deg);-moz-transform:rotate(0deg);-o-transform:rotate(0deg);-ms-transform:rotate(0deg);transform:rotate(0deg);}to{-webkit-transform:rotate(359deg);-moz-transform:rotate(359deg);-o-transform:rotate(359deg);-ms-transform:rotate(359deg);transform:rotate(359deg);}}@-o-keyframes "rot"{from{-webkit-transform:rotate(0deg);-moz-transform:rotate(0deg);-o-transform:rotate(0deg);-ms-transform:rotate(0deg);transform:rotate(0deg);}to{-webkit-transform:rotate(359deg);-moz-transform:rotate(359deg);-o-transform:rotate(359deg);-ms-transform:rotate(359deg);transform:rotate(359deg);}}@keyframes "rot"{from{-webkit-transform:rotate(0deg);-moz-transform:rotate(0deg);-o-transform:rotate(0deg);-ms-transform:rotate(0deg);transform:rotate(0deg);}to{-webkit-transform:rotate(359deg);-moz-transform:rotate(359deg);-o-transform:rotate(359deg);-ms-transform:rotate(359deg);transform:rotate(359deg);}}@-moz-keyframes rot{from{-webkit-transform:rotate(0deg);-moz-transform:rotate(0deg);-o-transform:rotate(0deg);-ms-transform:rotate(0deg);transform:rotate(0deg);}to{-webkit-transform:rotate(359deg);-moz-transform:rotate(359deg);-o-transform:rotate(359deg);-ms-transform:rotate(359deg);transform:rotate(359deg);}}@-webkit-keyframes "rot"{from{-webkit-transform:rotate(0deg);-moz-transform:rotate(0deg);-o-transform:rotate(0deg);-ms-transform:rotate(0deg);transform:rotate(0deg);}to{-webkit-transform:rotate(359deg);-moz-transform:rotate(359deg);-o-transform:rotate(359deg);-ms-transform:rotate(359deg);transform:rotate(359deg);}}@-ms-keyframes "rot"{from{-webkit-transform:rotate(0deg);-moz-transform:rotate(0deg);-o-transform:rotate(0deg);-ms-transform:rotate(0deg);transform:rotate(0deg);}to{-webkit-transform:rotate(359deg);-moz-transform:rotate(359deg);-o-transform:rotate(359deg);-ms-transform:rotate(359deg);transform:rotate(359deg);}}@-o-keyframes "rot"{from{-webkit-transform:rotate(0deg);-moz-transform:rotate(0deg);-o-transform:rotate(0deg);-ms-transform:rotate(0deg);transform:rotate(0deg);}to{-webkit-transform:rotate(359deg);-moz-transform:rotate(359deg);-o-transform:rotate(359deg);-ms-transform:rotate(359deg);transform:rotate(359deg);}}@keyframes "rot"{from{-webkit-transform:rotate(0deg);-moz-transform:rotate(0deg);-o-transform:rotate(0deg);-ms-transform:rotate(0deg);transform:rotate(0deg);}to{-webkit-transform:rotate(359deg);-moz-transform:rotate(359deg);-o-transform:rotate(359deg);-ms-transform:rotate(359deg);transform:rotate(359deg);}}@-moz-keyframes rot{from{-webkit-transform:rotate(0deg);-moz-transform:rotate(0deg);-o-transform:rotate(0deg);-ms-transform:rotate(0deg);transform:rotate(0deg);}to{-webkit-transform:rotate(359deg);-moz-transform:rotate(359deg);-o-transform:rotate(359deg);-ms-transform:rotate(359deg);transform:rotate(359deg);}}@-webkit-keyframes "rot"{from{-webkit-transform:rotate(0deg);-moz-transform:rotate(0deg);-o-transform:rotate(0deg);-ms-transform:rotate(0deg);transform:rotate(0deg);}to{-webkit-transform:rotate(359deg);-moz-transform:rotate(359deg);-o-transform:rotate(359deg);-ms-transform:rotate(359deg);transform:rotate(359deg);}}@-ms-keyframes "rot"{from{-webkit-transform:rotate(0deg);-moz-transform:rotate(0deg);-o-transform:rotate(0deg);-ms-transform:rotate(0deg);transform:rotate(0deg);}to{-webkit-transform:rotate(359deg);-moz-transform:rotate(359deg);-o-transform:rotate(359deg);-ms-transform:rotate(359deg);transform:rotate(359deg);}}@-o-keyframes "rot"{from{-webkit-transform:rotate(0deg);-moz-transform:rotate(0deg);-o-transform:rotate(0deg);-ms-transform:rotate(0deg);transform:rotate(0deg);}to{-webkit-transform:rotate(359deg);-moz-transform:rotate(359deg);-o-transform:rotate(359deg);-ms-transform:rotate(359deg);transform:rotate(359deg);}}@-ms-keyframes "rot"{-webkit-transform:rotate(0deg);-moz-transform:rotate(0deg);-o-transform:rotate(0deg);-ms-transform:rotate(0deg);transform:rotate(0deg);}to{-webkit-transform:rotate(359deg);-moz-transform:rotate(359deg);-o-transform:rotate(359deg);-ms-transform:rotate(359deg);transform:rotate(359deg);}} @-o-keyframes "rot"{-webkit-transform:rotate(0deg);-moz-transform:rotate(0deg);-o-transform:rotate(0deg);-ms-transform:rotate(0deg);transform:rotate(0deg);}to{-webkit-transform:rotate(359deg);-moz-transform:rotate(359deg);-o-transform:rotate(359deg);-ms-transform:rotate(359deg);transform:rotate(359deg);}',
            '</style>',
        ].join('\n');
    };

    var ieScriptLoadingTimer;

    self.ieLoadBugFix = function (script, callback){
        if (script.readyState=='loaded' || script.readyState=='completed') {
            clearTimeout(ieScriptLoadingTimer);
            callback(script);
        }else {
            ieScriptLoadingTimer = setTimeout(function() {self.ieLoadBugFix(script, callback); }, 100);
        }
    };

    self.addScript = function (src, callback) {
        var head = document.getElementsByTagName('head')[0];
        var script = document.createElement('script');
        script.type = 'text/javascript';
        script.src = src;
        script.onload = function () {
            clearTimeout(ieScriptLoadingTimer);
            callback(src);
        };
        // onload event for MSIE8
        self.ieLoadBugFix(script, callback);
        head.appendChild(script);
    };

    self.getHistoryData = function () {

        // if (jQuery.browser.msie && window.XDomainRequest) {
        if ('XDomainRequest' in window && window.XDomainRequest !== null) {
            // Use Microsoft XDR
            var xdr = new XDomainRequest();
            xdr.open("get", self._apiHistoryUrl);
            xdr.onload = function () {
            var data = jQuery.parseJSON(xdr.responseText);
            if (data === null || typeof (data) == 'undefined') {
                data = jQuery.parseJSON(data.firstChild.textContent);
            }
                // Success
                if (data.hasOwnProperty('d')) {
                    self.updateHistory(data.d, true);
                }
                if (data.hasOwnProperty('range')) {
                    self._range = data.range;
                }
            };
            xdr.send();
        } else {
            jQuery.getJSON(self._apiHistoryUrl, function (data){
                if (data.hasOwnProperty('d')) {
                    self.updateHistory(data.d, true);
                }
                if (data.hasOwnProperty('range')) {
                    self._range = data.range;
                    self.updateWidget();
                }
            })
            .error(function() {
                console.log('There was a problem loading data from the CoinDesk History API: ' + self._apiHistoryUrl);
            });
        }
    };


    self.getCurrentData = function () {

        // if (jQuery.browser.msie && window.XDomainRequest) {
        if ('XDomainRequest' in window && window.XDomainRequest !== null) {
            // Use Microsoft XDR
            var xdr = new XDomainRequest();
            xdr.open("get", self._apiCurrentUrl);
            xdr.onload = function () {
            var data = jQuery.parseJSON(xdr.responseText);
            if (data === null || typeof (data) == 'undefined') {
                data = jQuery.parseJSON(data.firstChild.textContent);
            }
                // Success
                self._data = data.bpi;
                self.receiveCoinDeskData(self._data);
            };
            xdr.send();
        } else {
            jQuery.getJSON(self._apiCurrentUrl, function (data){
                self._data = data.bpi;
                self.receiveCoinDeskData(self._data);
            })
            .error(function() {
                console.log('There was a problem loading data from the CoinDesk Price API:' + self._apiCurrentUrl);
            });
        }

        // Repeat this function, polling the API at a frequency
        // defined by self._pollingDelay
        setTimeout(self.getCurrentData, self._pollingDelay);
    };

    self.receiveCoinDeskData = function (apiData) {

        // Take most recent value in history to compare
        // for increase or decrease
        var oldValue = self._history.slice(-1)[0];

        self.updateRange(parseFloat(apiData.USD.rate_float));
        self.updateWidget();
        self.updateColor(oldValue, parseFloat(apiData.USD.rate_float));
        self.updateHistory(parseFloat(apiData.USD.rate_float));

        // We have data, display the widget
        if (self._data.USD) {
            jQuery(self._elements.slider).removeClass('widget-loading');
        }
    };

    self.updateRange = function (newValue) {
        if (typeof newValue !== 'undefined') {
            if ((newValue < self._range.low) || (typeof self._range.low == 'undefined')) {
                self._range.low = newValue;
            }
            if ((newValue > self._range.high) || (typeof self._range.high == 'undefined')) {
                self._range.high = newValue;
            }
        }
    };

    self.updateWidget = function () {
        for (var currIndex in self._currencies) {
            var currency = self._currencies[currIndex];
            var symbol = self._data[currency] ? self._data[currency].symbol : "";
            var currValue = self._data[currency] ? self.formatFloat(self._data[currency].rate_float) : "";
            self._elements[currency].innerHTML = symbol + currValue;
        }

        for (var metricIndex in self._metrics) {
            var metric = self._metrics[metricIndex];
            var metricValue = self._range[metric] ? self.formatFloat(self._range[metric]) : "";
            self._elements[metric].innerHTML = '$' + metricValue;
        }
    };

    self.createWidget = function () {
        self._widget.innerHTML = self._template;
        // If widget is right aligned, set overflow hidden to clear the float
        if (self._widget.alignment === 'right') {
            self._widget.style.overflow='hidden';
        }
        // Now supporting only USD, showing High and Low instead
        // self._elements.EUR = document.getElementById("btc-eur-field");
        // self._elements.GBP = document.getElementById("btc-gbp-field");
        self._elements.USD = document.getElementById("btc-usd-field");
        self._elements.high = document.getElementById("btc-range-high");
        self._elements.low = document.getElementById("btc-range-low");
        self._elements.slider = document.getElementById("btc-slider");

        // Set primary Currency for effects
        self._elements.primary = self._elements.USD;
    };

    self.updateHistory = function (value, initial) {
        // console.log('update history with:');
        // console.log(value);
        if (initial) {
            // Value is initial History population via Array
            self._history = value;
        } else {
            self._history.push(value);
        }

        // Drop support for sparkline for IE8 and Below
        if (self._modernBrowsers) {
            self.updateSparkline();
        }

        // console.log('history is now:');
        // console.log(self._history);
        // console.log('history length is now:');
        // console.log(self._history.length);
    };

    self.formatFloat = function (number, decimalPoints) {
        // Default to 2dp if none passed
        decimalPoints = typeof decimalPoints!== 'undefined' ? decimalPoints: 2;
        var formattedNumber = parseFloat(number);
        formattedNumber = formattedNumber.toFixed(decimalPoints);
        return formattedNumber;
    };

    self.getAlignment = function (alignment) {
        switch (alignment){
            case 'center':
                self._widget.config.alignment = 'margin: 0 auto';
                break;
            case 'right':
                self._widget.config.alignment = 'float: right';
                break;
            case 'left':
            /* falls through */
            default:
                self._widget.config.alignment = '';
                break;
        }
    };

    self.getDimensions = function (layout) {
        switch(layout) {
            case 'mpu':
                self._widget.config = {
                    name: 'mpu',
                    height: 250,
                    width: 300,
                    padding: 15,
                    spark: {
                        height: 135,
                        width: 300,
                        tooltip: true,
                        tooltipBg: false
                    },
                    logo: {
                        bitcoin: {
                            size: 40
                        },
                        coindesk: {
                            size: 50
                        }
                    },
                    text: {
                        primary: 40,
                        normal: 14,
                        small: 11
                    }
                };
                break;
            default:
                self._widget.config = {
                    name: 'small',
                    height: 130,
                    width: 210,
                    padding: 8,
                    spark: {
                        height: 50,
                        width: 210,
                        tooltip: true,
                        tooltipBg: true
                    },
                    logo: {
                        bitcoin: {
                            size: 30
                        },
                        coindesk: {
                            size: 30
                        }
                    },
                    text: {
                        primary: 30,
                        normal: 10,
                        small: 9
                    }
                };
        }
    };

    self.updateColor = function (oldPrice, newPrice) {
        if (newPrice < oldPrice) {
            jQuery(self._elements.primary).addClass("delta-down");
            jQuery(self._elements.primary).addClass("fadeInDown");
        }else if (newPrice > oldPrice) {
            jQuery(self._elements.primary).addClass("delta-up");
            jQuery(self._elements.primary).addClass("fadeInUp");
        }else{
            self.resetColor();
        }

        setTimeout(function () {
            self.resetColor();
        }, 1000);
    };

    self.resetColor = function () {
        jQuery(self._elements.primary).removeClass("fadeInUp");
        jQuery(self._elements.primary).removeClass("fadeInDown");
        jQuery(self._elements.primary).removeClass("delta-up");
        jQuery(self._elements.primary).removeClass("delta-down");
    };

    self.updateSparkline = function() {
        // Modified from http://bl.ocks.org/benjchristensen/1148374
        var id = "#sparkline";
        var width = self._widget.config.spark.width + 20 ;
        var height = self._widget.config.spark.height;
        var interpolation = "cardinal";
        var transitionDelay = 1000;
        var x,y,line;

        if (!self._graph) {
            self._graph = d3.select(id).append("svg:svg")
                    .attr("width", "100%")
                    .attr("height", "100%");
        }

        // Assuming 60 data points from self._apiHistoryUrl
        // Currently data for every minute of previous hour
        if (self._history.length > 60) {
            self._history.shift();
        }

        x = d3.scale.linear()
                    .domain([0, 60])
                    .range([-2, width]);

        y = d3.scale.linear()
                    .domain([d3.max(self._history)+1, d3.min(self._history)-0.3])
                    .range([0, height]);

        line = d3.svg.line()
                    .x(function(d,i) {
                        return x(i);
                    })
                    .y(function(d) {
                        return y(d);
                    })
                    .interpolate(interpolation);

        self._graph.selectAll('.btc-path').remove();
        self._graph.selectAll('.focus').remove();
        self._graph.selectAll('.overlay').remove();

        self._graph.append('svg:path')
                    .attr('d', line(self._history))
                    .attr('class', 'line');

        self._graph.selectAll('path')
                    .data([self._history])
                    .attr('transform', 'translate(' + x(1) + ')')
                    .attr('d', line)
                    .attr('class', 'btc-path')
                    .transition()
                    .ease('linear')
                    .duration(transitionDelay)
                    .attr('transform', 'translate(' + x(0) + ')');


        if (self._widget.config.spark.tooltip) {

            var tooltipText = function(d,i) {
                var text =  '$'+ d.toFixed(2) +' (' + (57-i) + 'mins ago)';
                return text;
            };

            var mousemove = function() {
                var x0 = x.invert(d3.mouse(this)[0]),
                    i = Math.floor(x0),
                    d0 = self._history[i + 1];

                focus.select('circle').attr('transform', 'translate(' + x(x0) + ',' + y(d0) + ')');
                focus.select('text').text(tooltipText(d0,i));
                focus.select('line').attr('transform', 'translate(' + x(x0) + ', 0)').attr('y1', height);
            };

            var focus = self._graph.append('g')
                .attr('class', 'focus')
                .style('display', 'none');

            focus.append('circle')
                .attr('r', 6);

            focus.append('line')
                .attr();

            if (self._widget.config.spark.tooltipBg) {

                // Background for tooltip if we want the sparkline to take up more
                // vertical space and potentially overlap
                focus.append('rect')
                    .attr('class', 'tooltipBg')
                    .attr('transform', 'translate(-10,0)')
                    .attr('width', 153)
                    .attr('height', 22)
                    .attr('rx', 4)
                    .attr('ry', 4);
            }

            focus.append('text')
                // .attr('transform', 'translate('+ (width - tooltipTextPlaceholder.width) +','+ (height - tooltipTextPlaceholder.height) +')');
                .attr('transform', 'translate(12,15)');

            self._graph.append('rect')
                .attr('class', 'overlay')
                .attr('width', width )
                .attr('height', height )
                .on('mouseover', function() { focus.style('display', null); })
                .on('mouseout', function() { focus.style('display', 'none'); })
                .on('mousemove', mousemove);
        }
    };
    // @TODO: To be hosted at CoinDesk and referenced fully
    self.addScript( self._protocol + '//widget.coindesk.com/bpiticker/jquery.ajax.only.d3.min.js', self.initialize);
};

var _widget = new BitcoinWidget();
